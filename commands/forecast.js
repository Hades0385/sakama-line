const axios = require('axios')
const moment = require("moment-timezone");
require('dotenv').config({ path: '../.env' });

const CWA_API = process.env.CWA_API;

module.exports = {
  name: "forecast",
  aliases: ["f","é å ±"],
  description: "æŸ¥è©¢å¤©æ°£é å ±ï¼Œä½¿ç”¨èªªæ˜:!f <é„‰é®å¸‚å€>",
  execute: async (args, client, event) => {
    let areas,twon;
    if (args.length === 2) {
        areas = area[args[0]];
        twon = args[1];
    } else {
        areas = area[findCity(args[0])];
        twon = args[0];
    } 
    if ((findCity(args[0]) === null && args.length === 1)||( !area[args[0]] && args.length === 2)) {
        console.log('âŒç„¡æ•ˆçš„é„‰é®å')
      }else {
        try {
            let response = await getData(areas,twon)
            let apiData = response.data.records.Locations[0].Location[0].WeatherElement;
            let apiInfo = response.data.records.Locations[0].Location[0]; 
          //24/12/10æ›´æ–°æ ¼å¼
            let temp = apiData[0].Time; 
            let ci = apiData[4].Time;
            let pop3 = apiData[7].Time; //æ¯ä¸‰å°æ™‚é™é›¨æ©Ÿç‡
            let wx = apiData[8].Time;
            let country = apiInfo.LocationName
            let t = timeCheck(temp[0].DataTime)
            let messageText = `ğŸŒ¤ï¸ ${country} æœªä¾† 3 å°æ™‚å¤©æ°£é å ±\n\n`;

            for (let i = 0; i < 3; i++) {
              messageText += `ğŸ•’ ${tTime(temp[t+i].DataTime)}\n`;
              messageText += `ğŸŒ¡ï¸ ${temp[t + i].ElementValue[0].Temperature}Â°C(${ci[t+i].ElementValue[0].ComfortIndexDescription})\n`;
              messageText += `ğŸ’§ ${pop3[Math.floor((t + i) / 3)].ElementValue[0].ProbabilityOfPrecipitation}%\n`;
              messageText += `${icon[wx[Math.floor(t+i / 3)].ElementValue[0].Weather]} ${wx[Math.floor((t + i) / 3)].ElementValue[0].Weather}\n`;
              messageText += `-------------------\n`;
            }
            messageText += `\nCWA`;
            const textMessage = {
              type: "text",
              text: messageText
            };
            
            await client.replyMessage(event.replyToken, textMessage);
            
        }catch(error) {
            console.log(error)
        }
      }
  },
};

async function getData(areas,twon) {
  return axios.get(`https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-D0047-${areas}?Authorization=${CWA_API}&limit=1&format=JSON&LocationName=${twon}`)
}

function tTime(timeString) {
  const timestamp = moment(timeString, "YYYY-MM-DD HH:mm:ss");
  return timestamp.format("YYYY/MM/DD HH:mm");
}

const area = {
    "å®œè˜­ç¸£" : "001" ,
    "æ¡ƒåœ’å¸‚" : "005" ,
    "æ–°ç«¹ç¸£" : "009" ,
    "è‹—æ —ç¸£" : "013" ,
    "å½°åŒ–ç¸£" : "017" ,
    "å—æŠ•ç¸£" : "021" ,
    "é›²æ—ç¸£" : "025" ,
    "å˜‰ç¾©ç¸£" : "029" ,
    "å±æ±ç¸£" : "033" ,
    "è‡ºæ±ç¸£" : "037" ,
    "èŠ±è“®ç¸£" : "041" ,
    "æ¾æ¹–ç¸£" : "045" ,
    "åŸºéš†å¸‚" : "049" ,
    "æ–°ç«¹å¸‚" : "053" ,
    "å˜‰ç¾©å¸‚" : "057" ,
    "è‡ºåŒ—å¸‚" : "061" ,
    "é«˜é›„å¸‚" : "065" ,
    "æ–°åŒ—å¸‚" : "069" ,
    "è‡ºä¸­å¸‚" : "073" ,
    "è‡ºå—å¸‚" : "077" ,
    "é€£æ±Ÿç¸£" : "081" ,
    "é‡‘é–€ç¸£" : "085" ,
};

const cityName ={
  'è‡ºåŒ—å¸‚': ['ä¸­æ­£å€', 'å¤§åŒå€', 'æ¾å±±å€', 'å¤§å®‰å€', 'è¬è¯å€', 'ä¿¡ç¾©å€', 'å£«æ—å€', 'åŒ—æŠ•å€', 'å…§æ¹–å€', 'å—æ¸¯å€', 'æ–‡å±±å€'],
  'æ–°åŒ—å¸‚': ['æ¿æ©‹å€', 'ä¸‰å³½å€', 'æ–°åº—å€', 'ä¸­å’Œå€', 'æ°¸å’Œå€', 'ä¸‰é‡å€', 'æ±æ­¢å€', 'æ¨¹æ—å€', 'é¶¯æ­Œå€', 'åœŸåŸå€', 'è˜†æ´²å€', 'äº”è‚¡å€', 'å…«é‡Œå€', 'æ·¡æ°´å€', 'ä¸‰èŠå€', 'çŸ³é–€å€'],
  'è‡ºä¸­å¸‚': ['ä¸­å€', 'æ±å€', 'å—å€', 'è¥¿å€', 'åŒ—å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'åŒ—å±¯å€', 'è±åŸå€', 'å¤§é‡Œå€', 'å¤ªå¹³å€', 'å¤§é›…å€', 'æ½­å­å€', 'å¤§è‚šå€', 'é¾äº•å€', 'éœ§å³°å€', 'çƒæ—¥å€', 'å¤§ç”²å€', 'æ¸…æ°´å€', 'æ²™é¹¿å€', 'æ¢§æ£²å€', 'å¤§å®‰å€'],
  'è‡ºå—å¸‚': ['ä¸­å€', 'æ±å€', 'å—å€', 'åŒ—å€', 'å®‰å¹³å€', 'å®‰å—å€', 'æ°¸åº·å€', 'æ­¸ä»å€', 'æ–°åŒ–å€', 'å·¦é®å€', 'ç‰äº•å€', 'æ¥ è¥¿å€', 'å—åŒ–å€', 'ä»å¾·å€', 'é—œå»Ÿå€', 'é¾å´å€', 'å®˜ç”°å€', 'éº»è±†å€', 'ä½³é‡Œå€', 'è¥¿æ¸¯å€', 'ä¸ƒè‚¡å€', 'å°‡è»å€', 'å­¸ç”²å€', 'åŒ—é–€å€', 'æ–°ç‡Ÿå€', 'å¾Œå£å€', 'ç™½æ²³å€', 'æ±å±±å€', 'å…­ç”²å€', 'å°æ¸¯å€'],
  'é«˜é›„å¸‚': ['æ¥ æ¢“å€', 'å·¦ç‡Ÿå€', 'é¼“å±±å€', 'ä¸‰æ°‘å€', 'é¹½åŸ•å€', 'è‹“é›…å€', 'å‰é‡‘å€', 'å‰é®å€', 'å°æ¸¯å€', 'å¤§å¯®å€', 'å¤§æ¨¹å€', 'å¤§ç¤¾å€', 'ä»æ­¦å€', 'é³¥æ¾å€', 'å²¡å±±å€', 'è·¯ç«¹å€', 'æ©‹é ­å€', 'æ¢“å®˜å€', 'å½Œé™€å€', 'æ°¸å®‰å€', 'æ¹–å…§å€', 'é³³å±±å€', 'æ—åœ’å€', 'èŒ„è£å€', 'æ——å±±å€', 'ç¾æ¿ƒå€', 'å…§é–€å€', 'æ‰æ—å€', 'ç”²ä»™å€', 'å…­é¾œå€', 'ä¸‰æ°‘å€', 'é¾å·–å€'],
  'åŸºéš†å¸‚': ['ä»æ„›å€', 'ä¿¡ç¾©å€', 'ä¸­æ­£å€', 'ä¸­å±±å€', 'å®‰æ¨‚å€', 'æš–æš–å€', 'ä¸ƒå µå€'],
  'æ¡ƒåœ’å¸‚': ['æ¡ƒåœ’å€', 'ä¸­å£¢å€', 'å¹³é®å€', 'å…«å¾·å€', 'æ¥Šæ¢…å€', 'è˜†ç«¹å€', 'å¤§æºªå€', 'é¾æ½­å€', 'å¤§åœ’å€', 'é¾œå±±å€'],
  'æ–°ç«¹å¸‚': ['æ±å€', 'åŒ—å€', 'é¦™å±±å€'],
  'æ–°ç«¹ç¸£': ['ç«¹åŒ—å¸‚', 'æ¹–å£é„‰', 'æ–°è±é„‰', 'æ–°åŸ”é®', 'é—œè¥¿é®', 'èŠæ—é„‰', 'æ©«å±±é„‰', 'äº”å³°é„‰', 'å¯¶å±±é„‰', 'ç«¹æ±é®', 'å°–çŸ³é„‰', 'åŒ—åŸ”é„‰', 'å³¨çœ‰é„‰'],
  'è‹—æ —ç¸£': ['è‹—æ —å¸‚', 'è‹‘è£¡é®', 'é€šéœ„é®', 'ç«¹å—é®', 'é ­ä»½é®', 'å¾Œé¾é®', 'ä¸‰ç¾©é„‰', 'è¥¿æ¹–é„‰', 'å…¬é¤¨é„‰', 'å¤§æ¹–é„‰', 'æ³°å®‰é„‰', 'é€ æ©‹é„‰', 'ä¸‰ç£é„‰', 'å—åº„é„‰', 'é ­å±‹é„‰', 'ç…æ½­é„‰', 'å“è˜­é®'],
  'å½°åŒ–ç¸£': ['å½°åŒ–å¸‚', 'é¹¿æ¸¯é®', 'å’Œç¾é®', 'ä¼¸æ¸¯é„‰', 'ç¦èˆˆé„‰', 'ç§€æ°´é„‰', 'èŠ±å£‡é„‰', 'èŠ¬åœ’é„‰', 'å¤§æ‘é„‰', 'åŸ”å¿ƒé„‰', 'åŸ”é¹½é„‰', 'ç”°ä¸­é®', 'ç”°å°¾é„‰', 'ç¤¾é ­é„‰', 'äºŒæ—é®', 'å¤§åŸé„‰', 'å°æ¸¯é„‰', 'æºªå·é„‰'],
  'å—æŠ•ç¸£': ['å—æŠ•å¸‚', 'åŸ”é‡Œé®', 'è‰å±¯é®', 'ç«¹å±±é®', 'é›†é›†é®', 'ä¸­å¯®é„‰', 'å—æŠ•é„‰', 'åœ‹å§“é„‰', 'æ°´é‡Œé„‰', 'ä¿¡ç¾©é„‰', 'ä»æ„›é„‰'],
  'å˜‰ç¾©å¸‚': ['æ±å€', 'è¥¿å€'],
  'å˜‰ç¾©ç¸£': ['å¤ªä¿å¸‚', 'æœ´å­å¸‚', 'å¸ƒè¢‹é®', 'é˜¿é‡Œå±±é„‰', 'æ¢…å±±é„‰', 'å¤§åŸ”é„‰', 'ä¸­åŸ”é„‰', 'æºªå£é„‰', 'å…­è…³é„‰', 'æ°´ä¸Šé„‰', 'é¹¿è‰é„‰', 'ä¸­åŸ”é„‰', 'å¤§æ—é®'],
  'é›²æ—ç¸£': ['æ–—å…­å¸‚', 'æ–—å—é®', 'è™å°¾é®', 'è¥¿èºé®', 'åœŸåº«é®', 'å¤§åŸ¤é„‰', 'è¤’å¿ é„‰', 'æ±å‹¢é„‰', 'è‡ºè¥¿é„‰', 'å´™èƒŒé„‰', 'éº¥å¯®é„‰', 'æ—å…§é„‰', 'äºŒå´™é„‰', 'è¥¿èºé®', 'åŒ—æ¸¯é®', 'å…ƒé•·é„‰', 'å››æ¹–é„‰', 'å£æ¹–é„‰', 'æ°´æ—é„‰'],
  'è‡ºå—ç¸£': ['å—åŒ–é„‰', 'å®‰å—å€', 'å®‰å¹³å€', 'æ±å€', 'åŒ—å€', 'ä¸­è¥¿å€', 'å®‰å—å€', 'æ°¸åº·å€', 'æ­¸ä»é„‰', 'æ–°åŒ–é„‰', 'å·¦é®é„‰', 'ç‰äº•é„‰', 'æ¥ è¥¿é„‰', 'ä»å¾·é„‰', 'é—œå»Ÿé„‰', 'é¾å´é„‰', 'å®˜ç”°é„‰', 'éº»è±†é„‰', 'ä½³é‡Œé®', 'è¥¿æ¸¯é„‰', 'ä¸ƒè‚¡é„‰', 'å°‡è»é„‰', 'å­¸ç”²é„‰', 'åŒ—é–€é„‰', 'æ–°ç‡Ÿå¸‚', 'å¾Œå£é„‰', 'ç™½æ²³é„‰', 'æ±å±±é„‰', 'å…­ç”²é„‰', 'å°æ¸¯å€'],
  'é«˜é›„ç¸£': ['å²¡å±±é®', 'è·¯ç«¹é®', 'æ¢“å®˜é®', 'å½Œé™€é®', 'æ°¸å®‰é„‰', 'æ¹–å…§é„‰', 'é³³å±±å€', 'ä»æ­¦é„‰', 'é³¥æ¾é„‰', 'å¤§ç¤¾é„‰', 'å¤§æ¨¹é„‰', 'æ——å±±é®', 'ç¾æ¿ƒé®', 'å…§é–€é„‰', 'æ‰æ—é„‰', 'ç”²ä»™é„‰', 'å…­é¾œé„‰', 'ä¸‰æ°‘å€', 'é¾å·–é„‰'],
  'å±æ±ç¸£': ['å±æ±å¸‚', 'ä¸‰åœ°é–€é„‰', 'éœ§è‡ºé„‰', 'ç‘ªå®¶é„‰', 'ä¹å¦‚é„‰', 'é‡Œæ¸¯é„‰', 'é«˜æ¨¹é„‰', 'é¹½åŸ”é„‰', 'é•·æ²»é„‰', 'éºŸæ´›é„‰', 'ç«¹ç”°é„‰', 'å…§åŸ”é„‰', 'è¬ä¸¹é„‰', 'æ½®å·é®', 'å—å·é„‰', 'æ±æ¸¯é®', 'æ†æ˜¥é®', 'å¢¾ä¸', 'è»ŠåŸé„‰', 'æ»¿å·é„‰', 'æ‹å¯®é„‰', 'æ‹å±±é„‰', 'æ–°åœ’é„‰', 'ä¹æ£šé„‰', 'æ—é‚Šé„‰'],
  'å®œè˜­ç¸£': ['å®œè˜­å¸‚', 'ç¾…æ±é®', 'è˜‡æ¾³é®', 'å†¬å±±é„‰', 'äº”çµé„‰', 'ä¸‰æ˜Ÿé„‰', 'å¤§åŒé„‰', 'å—æ¾³é„‰'],
  'èŠ±è“®ç¸£': ['èŠ±è“®å¸‚', 'é³³æ—é®', 'ç‰é‡Œé®', 'è±æ¿±é„‰', 'å£½è±é„‰', 'å…‰å¾©é„‰', 'æ–°åŸé„‰', 'å‰å®‰é„‰', 'å“æºªé„‰', 'ç‘ç©—é„‰', 'è¬æ¦®é„‰', 'é¯‰é­šæ½­'],
  'è‡ºæ±ç¸£': ['è‡ºæ±å¸‚', 'æˆåŠŸé®', 'é—œå±±é®', 'å‘å—é„‰', 'é¹¿é‡é„‰', 'æ± ä¸Šé„‰', 'æ±æ²³é„‰', 'é•·æ¿±é„‰', 'å¤ªéº»é‡Œé„‰', 'ç¶ å³¶é„‰', 'è˜­å¶¼é„‰'],
  'æ¾æ¹–ç¸£': ['é¦¬å…¬å¸‚', 'æ¹–è¥¿é„‰', 'ç™½æ²™é„‰', 'å—ç«¿é„‰', 'åŒ—ç«¿é„‰', 'æ±å¼•é„‰'],
  'é‡‘é–€ç¸£': ['é‡‘åŸé®', 'é‡‘æ¹–é®', 'é‡‘å¯§é„‰', 'é‡‘å—é„‰', 'é‡‘æ±é„‰', 'çƒˆå¶¼é„‰', 'çƒä¸˜é„‰'],
  'é€£æ±Ÿç¸£': ['å—ç«¿é„‰', 'åŒ—ç«¿é„‰', 'æ±å¼•é„‰', 'è’å…‰é„‰', 'é¦¬ç¥–é„‰']
};

function findCity(areas) {
  for (const county in cityName) {
    if (cityName[county].includes(areas)) {
      return county;
    }
  }
  return null;
}

const icon = {
  'æ™´':'â˜€ï¸',
  'å¤šé›²':'â›…',
  'åˆå¾ŒçŸ­æš«é›·é™£é›¨':'â˜€ï¸ -> â›ˆï¸',
  'çŸ­æš«é™£é›¨':'ğŸŒ§ï¸',
  'é™£é›¨':'ğŸŒ§ï¸',
  'çŸ­æš«é™£é›¨æˆ–é›·é›¨':'ğŸŒ§ï¸/â›ˆï¸',
  'é™°':'â˜ï¸',
  'é™£é›¨æˆ–é›·é›¨':'ğŸŒ§ï¸/â›ˆï¸',
  'çŸ­æš«é›¨':'ğŸŒ§ï¸',
}

function timeCheck(time) {
  const timestamp = moment.tz(time, "YYYY-MM-DD HH:mm:ss", "Asia/Taipei"); 
  const hours = timestamp.hours(); 
  let currentHour = moment().tz("Asia/Taipei").hour(); 
  let i = currentHour - hours + 1;
  return i;
}